# ScoreSharp.API 權限設定說明文檔

## 🔧 權限系統架構概覽

ScoreSharp.API 採用**雙層權限架構**：

1. **通用 RBAC 權限系統** - 控制 API 層級的訪問權限（適用於所有 API）
2. **徵審 UI 權限系統** - 控制徵審作業頁面按鈕顯示（僅限徵審作業）

---

## 基本權限設定

<aside>

**❗ 每支 API 都要設定**

</aside>

### **完整設定流程 (Step 1-5)**

#### **Step 1：路由類別設定**

📁 **控制器**: `RouterCategoryController`

建立路由分類，例如：

- `SetUp` - 設定作業
- `Review` - 徵審作業
- `Report` - 報表作業

#### **Step 2：路由設定**

📁 **控制器**: `RouterController`

建立具體路由並關聯到路由類別，例如：

- `SetUpBlackListReason` - 黑名單理由設定 (關聯到 SetUp)
- `ReviewApply` - 徵審申請書 (關聯到 Review)

#### **Step 3：操作設定**

📁 **控制器**: `ActionController`

建立具體 API 操作並關聯到路由，例如：

```csharp
{
    "ActionId": "GetBlackListReasonById",
    "ActionName": "取得單筆黑名單理由",
    "RouterId": "SetUpBlackListReason",
    "IsActive": "Y",
    "IsCommon": "N"  // Y=全員可用, N=需要權限控制
}
```

#### **Step 4：角色設定**

📁 **控制器**: `RoleController`

建立角色，例如：

- `Admin` - 系統管理員
- `Reviewer` - 徵審人員
- `Customer` - 客戶

#### **Step 5：角色權限關聯**

📁 **控制器**: `RoleController`

設定哪些角色可以執行哪些 Action，透過 `Auth_Role_Router_Action` 表關聯。

### **實際應用 - API 權限控制**

在 Controller 上套用權限：

```csharp
[Authorize(Policy = SecurityConstants.Policy.RBAC)]
public class YourController : ControllerBase
{
    [HttpGet]
    [OpenApiOperation("GetSomething")]  // ActionId = "GetSomething"
    public async Task<IResult> GetSomething()
    {
        // 業務邏輯
    }
}
```

### **權限檢查邏輯**

1. **Token 驗證** - 確認使用者身份
2. **Action 檢查** - 確認 Action 是否存在且啟用
3. **Common 權限** - 如果`IsCommon="Y"`，直接通過
4. **角色權限** - 如果`IsCommon="N"`，檢查角色是否有該 Action 權限

---

## 徵審權限設定

<aside>

**⚠️ 和徵審作業-徵信人員個人工作清單畫面中的按鈕相關才須設定**

</aside>

### **Step 6：徵審 UI 權限設定**

📁 **控制器**: `ReviewerPermissionController`

#### **設定目的**

針對**徵審作業頁面**，根據**申請書狀態**(`CardStatus`)和**卡片階段**(`CardStep`)來決定哪些按鈕要顯示/隱藏。

#### **權限控制粒度**

系統提供 40+個按鈕的權限控制，包括：

```csharp
// 月收入確認相關按鈕
MonthlyIncome_IsShowChangeCaseType = "Y"        // 變更案件種類
MonthlyIncome_IsShowMonthlyIncome = "Y"         // 月收入確認

// 基本操作按鈕
IsShowNameCheck = "Y"                           // 姓名檢核
IsShowUpdatePrimaryInfo = "Y"                   // 更新正卡人基本資料
IsShowQuery929 = "Y"                           // 查詢929
IsShowInsertFileAttachment = "Y"               // 新增圖檔

// 人工徵審相關按鈕
ManualReview_IsShowInPermission = "Y"          // 權限內
ManualReview_IsShowOutPermission = "Y"         // 權限外
ManualReview_IsShowReturnReview = "Y"          // 退回重審
```

#### **運作流程**

1. **前端載入徵審頁面** → 呼叫 `GET /ReviewerPermission/GetApplyPermissionById/{applyNo}`
2. **後端權限計算**：
   - 查詢申請書當前狀態(`CardStatus`)和階段(`CardStep`)
   - 從`Auth_ReviewerPermission`找到對應權限設定
   - 檢查是否為當前經辦人(`IsCurrentHandleUserId`)
   - 多狀態權限合併（取最大值：任一為"Y"即為"Y"）
3. **前端接收權限物件** → 根據各個`IsShow...`欄位控制按鈕顯示

**於權限作業-徵審權限設定中，根據狀態、卡片階段、驗別是否為當前經辦為前提去做設定**

---

## 💡 完整權限檢查流程

### **🌐 一般頁面 (通用 RBAC 權限)**

```
前端載入頁面 → 根據ActionId綁定按鈕顯示 → 使用者點擊按鈕 → 呼叫對應API → @/Security RBAC權限檢查 → 執行業務邏輯
```

**流程說明**：

1. **前端 UI 層**：根據**ActionId**綁定來判斷按鈕是否顯示
2. **後端 API 層**：透過`@/Security`的**RBAC 檢查**驗證權限

### **🎯 徵審作業頁面 (雙重權限)**

```
前端載入徵審頁面 → 根據ActionId綁定按鈕顯示 → 額外呼叫GetApplyPermissionById → 取得UI按鈕顯示權限 → 合併兩種權限結果 → 使用者點擊按鈕 → 呼叫對應API → @/Security RBAC權限檢查 → 執行業務邏輯
```

**流程說明**：

1. **前端 UI 層**：
   - **基本權限**：根據**ActionId**綁定判斷按鈕顯示
   - **額外權限**：呼叫`GetApplyPermissionById`取得狀態相關的 UI 權限
   - **合併結果**：兩種權限都通過才顯示按鈕
2. **後端 API 層**：透過`@/Security`的**RBAC 檢查**驗證權限

---

## 🔧 實際運作範例

### **一般頁面（例如：設定作業）**

```javascript
// 前端邏輯
if (hasActionPermission("GetBlackListReasonById")) {
  showButton("查詢按鈕");
}
```

### **徵審作業頁面**

```javascript
// 前端邏輯
const basicPermission = hasActionPermission("GetApplyPermissionById");
const uiPermission = await getApplyPermissionById(applyNo);

if (basicPermission && uiPermission.IsShowInsertFileAttachment === "Y") {
  showButton("新增圖檔按鈕");
}
```

---

## ✅ 權限設定總結

### **Step 1-5 (通用 RBAC)**：

- **適用範圍**：**所有 API 頁面**（包含徵審作業）
- **前端邏輯**：根據`ActionId`綁定按鈕顯示
- **後端檢查**：透過`@/Security`進行 RBAC 驗證

### **Step 6 (徵審 UI 權限)**：

- **適用範圍**：**僅限徵審作業頁面**
- **前端邏輯**：額外呼叫`GetApplyPermissionById`取得 UI 權限
- **後端檢查**：仍然透過`@/Security`進行 RBAC 驗證

### **雙重保護機制**：

- 即使徵審作業有額外的 UI 權限控制
- 所有 API 呼叫仍然要通過 Step 1-5 的 RBAC 權限檢查
- 這確保了後端的安全性不會因為前端 UI 權限而被繞過

### **設定順序**：

✅ **路由類別** → ✅ **路由** → ✅ **操作** → ✅ **角色** → ✅ **權限關聯** → ✅ **API 套用** → ✅ **徵審 UI 權限**（如需要）

**每個新的 API 都需要**：

1. 確保對應的`ActionId`已在`Auth_Action`中註冊
2. 在 Controller 的 Action 上標示`[OpenApiOperation("ActionId")]`
3. 在 Controller 上套用`[Authorize(Policy = SecurityConstants.Policy.RBAC)]`
